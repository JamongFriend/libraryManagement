<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>ISBNìœ¼ë¡œ ë„ì„œ ê²€ìƒ‰ Â· ë“±ë¡</title>
  <style>
    .wrap { max-width: 760px; margin: 0 auto; }
    .row { margin: 8px 0; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    .muted { color:#666; font-size: 0.9em; }
  </style>
</head>
<body>
<div th:replace="~{header :: header}"></div>

<div class="wrap">
  <h1>ğŸ“š ISBNìœ¼ë¡œ ë„ì„œ ê²€ìƒ‰ Â· ë“±ë¡</h1>
  <div class="row">
    <input id="isbnInput" type="text" placeholder="ISBN(10 ë˜ëŠ” 13ìë¦¬)" style="width:60%;">
    <button id="btnLookup">ê²€ìƒ‰</button>
  </div>
  <div class="row muted">í•˜ì´í”ˆ/ê³µë°±ì€ ìë™ìœ¼ë¡œ ì œê±°ë©ë‹ˆë‹¤.</div>

  <div id="resultBox" style="display:none;">
    <h3>ê²€ìƒ‰ ê²°ê³¼</h3>
    <table>
      <tbody>
      <tr><th>ì œëª©</th><td id="rTitle"></td></tr>
      <tr><th>ì €ì</th><td id="rAuthor"></td></tr>
      <tr><th>ì¶œíŒì‚¬</th><td id="rPublisher"></td></tr>
      <tr><th>ë°œí–‰ì¼</th><td id="rPubDate"></td></tr>
      <tr><th>ISBN</th><td id="rIsbn"></td></tr>
      </tbody>
    </table>

    <div class="row">
      <label>ë“±ë¡/ì¦ê°€ ìˆ˜ëŸ‰: <input id="stockInput" type="number" min="1" value="1" style="width:80px;"></label>
      <button id="btnRegister">ì¦‰ì‹œ ë“±ë¡/ì¬ê³ ì¦ê°€</button>
    </div>
    <div id="registerMsg" class="row"></div>
  </div>

  <div id="emptyMsg" class="row" style="display:none;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  <div id="errorMsg" class="row" style="display:none; color:#c00;"></div>

  <div class="row">
    <a th:href="@{/books}">â† ë„ì„œ ëª©ë¡ìœ¼ë¡œ</a>
  </div>
</div>

<div th:replace="~{footer :: footer}"></div>

<script>
  const $ = (sel) => document.querySelector(sel);

  function normalize(isbn) {
    return (isbn || '').replace(/[^0-9Xx]/g, '').toUpperCase();
  }

  $('#btnLookup').addEventListener('click', async () => {
    const raw = $('#isbnInput').value;
    const isbn = normalize(raw);
    $('#errorMsg').style.display = 'none';
    $('#emptyMsg').style.display = 'none';
    $('#resultBox').style.display = 'none';

    if (!isbn || !(isbn.length === 10 || isbn.length === 13)) {
      $('#errorMsg').textContent = 'ìœ íš¨í•˜ì§€ ì•Šì€ ISBN í˜•ì‹ì…ë‹ˆë‹¤. (10ìë¦¬ ë˜ëŠ” 13ìë¦¬)';
      $('#errorMsg').style.display = 'block';
      return;
    }

    try {
      const res = await fetch(`/api/books/lookup-isbn?isbn=${encodeURIComponent(isbn)}`);
      if (res.status === 404) {
        $('#emptyMsg').style.display = 'block';
        return;
      }
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      const dto = await res.json();
      // dto: ApiBookDto (title, author, publisher, pubDate, isbn ë“±)
      $('#rTitle').textContent = dto.title ?? '';
      $('#rAuthor').textContent = dto.author ?? '';
      $('#rPublisher').textContent = dto.publisher ?? '';
      $('#rPubDate').textContent = dto.pubDate ?? '';
      $('#rIsbn').textContent = dto.isbn ?? isbn;

      $('#resultBox').style.display = 'block';
    } catch (e) {
      $('#errorMsg').textContent = e.message;
      $('#errorMsg').style.display = 'block';
    }
  });

  $('#btnRegister').addEventListener('click', async () => {
    const isbn = normalize($('#rIsbn').textContent || $('#isbnInput').value);
    const stock = parseInt($('#stockInput').value || '1', 10);
    $('#registerMsg').textContent = '';

    try {
      const body = new URLSearchParams({ isbn, stock: String(stock) });
      const res = await fetch('/api/books/register-by-isbn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      const id = await res.json(); // Long
      $('#registerMsg').textContent = `ë“±ë¡/ì¦ê°€ ì™„ë£Œ! (ë„ì„œ ID: ${id})`;
      // í•„ìš”ì‹œ ë„ì„œ ìƒì„¸/ëª©ë¡ìœ¼ë¡œ ì´ë™:
      // window.location.href = '/books';
    } catch (e) {
      $('#registerMsg').textContent = e.message;
      $('#registerMsg').style.color = '#c00';
    }
  });
</script>
</body>
</html>
